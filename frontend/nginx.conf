server {
    listen 80;
    server_name localhost;

    # 启用 gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # 前端静态文件
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache";
    }

    # 用户服务 - 使用简单的 rewrite
    location /api/register {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://user-service:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/login {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://user-service:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/profile {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://user-service:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /api/refresh {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://user-service:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 账户服务
    location /api/accounts {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://account-service:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;
    }

    # 交易服务
    location /api/transactions {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://transaction-service:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;
    }

    location /api/categories {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://transaction-service:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;
    }

    # 预算服务
    location /api/budgets {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://budget-service:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;
    }

    # 报表服务
    location /api/reports {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://report-service:3004;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;
    }

    # 汇率服务
    location /api/quotes {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://quote-service:3005;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;
    }
}
