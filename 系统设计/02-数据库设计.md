# 数据库设计

## 1. 数据库选型

### 1.1 数据库组合

| 数据库 | 用途 | 理由 |
|-------|------|------|
| **MongoDB** | 核心业务数据 | 灵活schema、高性能、事务支持 |
| **PostgreSQL** | 用户认证数据 | 强一致性、成熟的用户管理 |
| **Redis** | 缓存与会话 | 高性能内存存储 |
| **TimescaleDB** | 时序数据 | 专为时序数据优化 |

## 2. MongoDB 数据模型设计

### 2.1 用户集合 (users)

```javascript
{
  _id: ObjectId("..."),
  username: "zhangsan",           // 用户名，唯一
  email: "zhangsan@example.com",  // 邮箱，唯一
  password_hash: "...",            // 密码哈希 (Argon2id)
  full_name: "张三",               // 真实姓名
  avatar_url: "https://...",       // 头像URL
  phone: "+8613800138000",         // 手机号
  settings: {                      // 用户设置
    default_currency: "CNY",       // 默认币种
    timezone: "Asia/Shanghai",     // 时区
    language: "zh-CN",             // 语言
    theme: "light",                // 主题 (light/dark)
    notifications: {               // 通知设置
      email: true,
      push: true,
      budget_alert: true
    }
  },
  status: "active",                // 状态: active/suspended/deleted
  created_at: ISODate("2024-01-01T00:00:00Z"),
  updated_at: ISODate("2024-01-01T00:00:00Z"),
  last_login_at: ISODate("2024-01-15T08:30:00Z")
}
```

**索引设计**:
```javascript
db.users.createIndex({ username: 1 }, { unique: true });
db.users.createIndex({ email: 1 }, { unique: true });
db.users.createIndex({ status: 1, created_at: -1 });
```

### 2.2 账户集合 (accounts)

```javascript
{
  _id: ObjectId("..."),
  user_id: ObjectId("..."),        // 所属用户ID
  name: "招商银行储蓄卡",           // 账户名称
  type: "debit_card",              // 账户类型
  // 类型枚举: cash(现金), debit_card(储蓄卡), credit_card(信用卡), 
  //          investment(投资账户), loan(贷款), ewallet(电子钱包)
  currency: "CNY",                 // 账户币种
  initial_balance: 10000.00,       // 初始余额
  current_balance: 15234.56,       // 当前余额
  available_credit: 50000.00,      // 可用额度(信用卡专用)
  icon: "bank",                    // 图标标识
  color: "#1890ff",                // 显示颜色
  description: "工资卡",            // 备注说明
  meta: {                          // 扩展元数据
    bank_name: "招商银行",
    card_number: "****1234",
    account_holder: "张三"
  },
  is_excluded_from_total: false,   // 是否从总资产中排除
  status: "active",                // 状态: active/archived
  created_at: ISODate("2024-01-01T00:00:00Z"),
  updated_at: ISODate("2024-12-02T10:30:00Z")
}
```

**索引设计**:
```javascript
db.accounts.createIndex({ user_id: 1, status: 1 });
db.accounts.createIndex({ user_id: 1, type: 1 });
db.accounts.createIndex({ user_id: 1, currency: 1 });
```

### 2.3 交易集合 (transactions)

```javascript
{
  _id: ObjectId("..."),
  user_id: ObjectId("..."),        // 所属用户ID
  type: "expense",                 // 交易类型: expense(支出), income(收入), transfer(转账)
  amount: 238.50,                  // 交易金额(绝对值)
  currency: "CNY",                 // 交易币种
  
  // 关联账户
  account_id: ObjectId("..."),     // 账户ID
  to_account_id: ObjectId("..."),  // 转账目标账户(仅transfer类型)
  
  // 分类与标签
  category_id: ObjectId("..."),    // 分类ID
  subcategory_id: ObjectId("..."), // 子分类ID(可选)
  tags: ["餐饮", "聚餐"],           // 标签数组
  
  // 交易详情
  description: "与朋友聚餐",        // 交易描述
  payee: "海底捞火锅",             // 收款方/付款方
  transaction_date: ISODate("2024-12-01T18:30:00Z"), // 交易时间
  location: {                      // 地理位置(可选)
    latitude: 39.9042,
    longitude: 116.4074,
    address: "北京市朝阳区..."
  },
  
  // 附件
  attachments: [                   // 附件列表(票据、发票等)
    {
      file_id: "...",
      file_name: "receipt.jpg",
      file_url: "https://...",
      file_size: 102400,
      upload_at: ISODate("2024-12-01T19:00:00Z")
    }
  ],
  
  // 去重标识
  dedup_hash: "md5hash...",        // 去重哈希(金额+日期+描述)
  external_id: "alipay_123456",    // 外部系统ID(用于导入对账)
  
  // 状态与元数据
  status: "confirmed",             // 状态: pending(待确认), confirmed(已确认), cancelled(已取消)
  notes: "年终聚餐",                // 备注
  created_at: ISODate("2024-12-01T18:35:00Z"),
  updated_at: ISODate("2024-12-01T18:35:00Z"),
  created_by: "manual"             // 创建方式: manual(手动), import(导入), api(API)
}
```

**索引设计**:
```javascript
// 复合索引 - 用户按时间查询
db.transactions.createIndex({ 
  user_id: 1, 
  transaction_date: -1 
});

// 复合索引 - 用户+账户查询
db.transactions.createIndex({ 
  user_id: 1, 
  account_id: 1, 
  transaction_date: -1 
});

// 复合索引 - 用户+分类统计
db.transactions.createIndex({ 
  user_id: 1, 
  category_id: 1, 
  transaction_date: -1 
});

// 去重索引
db.transactions.createIndex({ 
  user_id: 1, 
  dedup_hash: 1 
}, { unique: true, sparse: true });

// 外部ID索引
db.transactions.createIndex({ 
  user_id: 1, 
  external_id: 1 
}, { sparse: true });

// 状态索引
db.transactions.createIndex({ 
  user_id: 1, 
  status: 1 
});
```

### 2.4 分类集合 (categories)

```javascript
{
  _id: ObjectId("..."),
  user_id: ObjectId("..."),        // null表示系统预设分类
  name: "餐饮美食",                 // 分类名称
  type: "expense",                 // 适用类型: expense/income
  icon: "food",                    // 图标
  color: "#ff6b6b",                // 颜色
  parent_id: null,                 // 父分类ID (null表示顶级分类)
  order: 1,                        // 显示顺序
  is_system: true,                 // 是否系统预设
  is_archived: false,              // 是否归档
  created_at: ISODate("2024-01-01T00:00:00Z"),
  updated_at: ISODate("2024-01-01T00:00:00Z")
}

// 子分类示例
{
  _id: ObjectId("..."),
  user_id: ObjectId("..."),
  name: "快餐",
  type: "expense",
  icon: "fast-food",
  color: "#ff6b6b",
  parent_id: ObjectId("..."),      // 指向"餐饮美食"分类
  order: 1,
  is_system: false,
  is_archived: false,
  created_at: ISODate("2024-01-01T00:00:00Z"),
  updated_at: ISODate("2024-01-01T00:00:00Z")
}
```

**索引设计**:
```javascript
db.categories.createIndex({ user_id: 1, type: 1, order: 1 });
db.categories.createIndex({ user_id: 1, parent_id: 1 });
db.categories.createIndex({ is_system: 1, type: 1 });
```

### 2.5 预算集合 (budgets)

```javascript
{
  _id: ObjectId("..."),
  user_id: ObjectId("..."),        // 所属用户
  name: "2024年12月餐饮预算",       // 预算名称
  type: "monthly",                 // 预算周期: daily/weekly/monthly/yearly/custom
  
  // 时间范围
  start_date: ISODate("2024-12-01T00:00:00Z"),
  end_date: ISODate("2024-12-31T23:59:59Z"),
  
  // 预算设置
  amount: 3000.00,                 // 预算金额
  currency: "CNY",                 // 币种
  
  // 适用范围
  category_ids: [ObjectId("...")], // 适用的分类ID列表 (空数组表示全部)
  account_ids: [ObjectId("...")],  // 适用的账户ID列表 (空数组表示全部)
  
  // 执行统计
  spent: 1456.80,                  // 已支出金额
  remaining: 1543.20,              // 剩余金额
  progress: 48.56,                 // 执行进度百分比
  
  // 预警设置
  alert_thresholds: [              // 预警阈值
    { percentage: 50, notified: true },
    { percentage: 80, notified: false },
    { percentage: 100, notified: false }
  ],
  
  // 预测数据
  prediction: {
    predicted_total: 3200.00,      // 预测总支出
    predicted_exceed: 200.00,      // 预测超支金额
    confidence: 0.85,              // 预测置信度
    algorithm: "sliding_window",   // 使用的算法
    updated_at: ISODate("2024-12-02T00:00:00Z")
  },
  
  status: "active",                // 状态: active/completed/paused
  created_at: ISODate("2024-11-25T00:00:00Z"),
  updated_at: ISODate("2024-12-02T10:30:00Z")
}
```

**索引设计**:
```javascript
db.budgets.createIndex({ user_id: 1, status: 1, start_date: -1 });
db.budgets.createIndex({ user_id: 1, end_date: 1 });
db.budgets.createIndex({ 
  user_id: 1, 
  start_date: 1, 
  end_date: 1 
});
```

### 2.6 汇率集合 (exchange_rates)

```javascript
{
  _id: ObjectId("..."),
  base_currency: "CNY",            // 基准货币
  target_currency: "USD",          // 目标货币
  rate: 0.1389,                    // 汇率 (1 CNY = 0.1389 USD)
  source: "central_bank",          // 数据源: central_bank/yahoo/manual
  timestamp: ISODate("2024-12-02T10:00:00Z"),
  
  // 多源融合数据
  sources_data: [
    {
      source: "central_bank",
      rate: 0.1389,
      weight: 0.5
    },
    {
      source: "yahoo",
      rate: 0.1392,
      weight: 0.3
    },
    {
      source: "manual",
      rate: 0.1390,
      weight: 0.2
    }
  ],
  
  // 卡尔曼滤波参数
  kalman_state: {
    estimate: 0.1389,
    error_covariance: 0.0001
  },
  
  created_at: ISODate("2024-12-02T10:00:00Z")
}
```

**索引设计**:
```javascript
db.exchange_rates.createIndex({ 
  base_currency: 1, 
  target_currency: 1, 
  timestamp: -1 
});
db.exchange_rates.createIndex({ timestamp: -1 });
```

### 2.7 仪表盘配置集合 (dashboards)

```javascript
{
  _id: ObjectId("..."),
  user_id: ObjectId("..."),
  name: "我的首页",
  is_default: true,                // 是否默认仪表盘
  layout: [                        // 布局配置
    {
      widget_id: "net_worth",
      position: { x: 0, y: 0, w: 6, h: 4 },
      config: {
        show_trend: true,
        time_range: "1M"
      }
    },
    {
      widget_id: "expense_category",
      position: { x: 6, y: 0, w: 6, h: 4 },
      config: {
        chart_type: "pie",
        top_n: 10
      }
    },
    {
      widget_id: "budget_progress",
      position: { x: 0, y: 4, w: 12, h: 3 },
      config: {
        show_all: true
      }
    }
  ],
  created_at: ISODate("2024-01-01T00:00:00Z"),
  updated_at: ISODate("2024-12-02T10:30:00Z")
}
```

**索引设计**:
```javascript
db.dashboards.createIndex({ user_id: 1, is_default: 1 });
```

## 3. PostgreSQL 数据模型

### 3.1 用户表 (users)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    uuid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    phone VARCHAR(20),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP
);

CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_email ON users(email);
```

### 3.2 会话表 (sessions)

```sql
CREATE TABLE sessions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    token_hash VARCHAR(255) UNIQUE NOT NULL,
    refresh_token_hash VARCHAR(255) UNIQUE,
    device_info JSONB,
    ip_address INET,
    user_agent TEXT,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_token ON sessions(token_hash);
CREATE INDEX idx_sessions_expires ON sessions(expires_at);
```

## 4. Redis 缓存设计

### 4.1 缓存键命名规范

```
模式: <prefix>:<entity>:<id>:<field>

示例:
- abook:user:123:profile              // 用户资料
- abook:account:456:balance           // 账户余额
- abook:transaction:789:detail        // 交易详情
- abook:budget:101:progress           // 预算进度
- abook:rate:CNY:USD:latest           // 最新汇率
- abook:session:token:abc123          // 会话令牌
- abook:stats:user:123:monthly        // 月度统计
```

### 4.2 缓存数据结构

#### 4.2.1 用户会话 (String)
```redis
Key: abook:session:token:{token_hash}
Value: {"user_id": 123, "expires_at": 1701504000}
TTL: 7200 (2小时)
```

#### 4.2.2 账户余额 (Hash)
```redis
Key: abook:account:{account_id}:balance
Fields:
  current: 15234.56
  currency: CNY
  updated_at: 1701504000
TTL: 300 (5分钟)
```

#### 4.2.3 用户账户列表 (List)
```redis
Key: abook:user:{user_id}:accounts
Value: [account_id_1, account_id_2, ...]
TTL: 600 (10分钟)
```

#### 4.2.4 预算进度 (Hash)
```redis
Key: abook:budget:{budget_id}:progress
Fields:
  amount: 3000.00
  spent: 1456.80
  remaining: 1543.20
  progress: 48.56
TTL: 60 (1分钟)
```

#### 4.2.5 汇率缓存 (String)
```redis
Key: abook:rate:{base}:{target}:latest
Value: 0.1389
TTL: 3600 (1小时)
```

#### 4.2.6 统计数据 (Hash)
```redis
Key: abook:stats:user:{user_id}:monthly:{year}-{month}
Fields:
  total_income: 15000.00
  total_expense: 8500.00
  net: 6500.00
  transaction_count: 156
TTL: 86400 (24小时)
```

#### 4.2.7 排行榜 (Sorted Set)
```redis
Key: abook:leaderboard:expense:category:{year}-{month}
Members: category_id_1, category_id_2, ...
Scores: 金额
TTL: 86400 (24小时)
```

### 4.3 缓存更新策略

| 场景 | 策略 | 说明 |
|-----|------|------|
| 用户登录 | Write-Through | 写入数据库同时写入缓存 |
| 账户余额 | Cache-Aside | 读取时加载，修改时删除缓存 |
| 预算进度 | Write-Through | 实时更新缓存 |
| 统计数据 | 定时刷新 | 每小时重新计算 |
| 汇率数据 | 定时更新 | 每分钟拉取最新数据 |

## 5. TimescaleDB 时序数据

### 5.1 账户余额历史表

```sql
CREATE TABLE account_balance_history (
    time TIMESTAMPTZ NOT NULL,
    account_id UUID NOT NULL,
    balance NUMERIC(19, 4) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    snapshot_type VARCHAR(20) NOT NULL, -- auto/manual
    PRIMARY KEY (account_id, time)
);

-- 转换为超表
SELECT create_hypertable('account_balance_history', 'time');

-- 创建索引
CREATE INDEX idx_balance_history_account ON account_balance_history (account_id, time DESC);

-- 数据保留策略 (保留2年)
SELECT add_retention_policy('account_balance_history', INTERVAL '2 years');

-- 压缩策略 (超过7天的数据压缩)
ALTER TABLE account_balance_history SET (
  timescaledb.compress,
  timescaledb.compress_segmentby = 'account_id'
);

SELECT add_compression_policy('account_balance_history', INTERVAL '7 days');
```

### 5.2 汇率历史表

```sql
CREATE TABLE exchange_rate_history (
    time TIMESTAMPTZ NOT NULL,
    base_currency VARCHAR(3) NOT NULL,
    target_currency VARCHAR(3) NOT NULL,
    rate NUMERIC(19, 8) NOT NULL,
    source VARCHAR(50) NOT NULL,
    PRIMARY KEY (base_currency, target_currency, time)
);

SELECT create_hypertable('exchange_rate_history', 'time');

CREATE INDEX idx_rate_history_pair ON exchange_rate_history (base_currency, target_currency, time DESC);

SELECT add_retention_policy('exchange_rate_history', INTERVAL '1 year');
```

### 5.3 预算执行历史表

```sql
CREATE TABLE budget_execution_history (
    time TIMESTAMPTZ NOT NULL,
    budget_id UUID NOT NULL,
    spent NUMERIC(19, 4) NOT NULL,
    remaining NUMERIC(19, 4) NOT NULL,
    progress NUMERIC(5, 2) NOT NULL,
    PRIMARY KEY (budget_id, time)
);

SELECT create_hypertable('budget_execution_history', 'time');

CREATE INDEX idx_budget_history ON budget_execution_history (budget_id, time DESC);

SELECT add_retention_policy('budget_execution_history', INTERVAL '2 years');
```

## 6. 数据一致性保证

### 6.1 分布式事务

使用**Saga模式**处理跨数据库事务:

```rust
// 转账场景
async fn transfer_money(from_account: ObjectId, to_account: ObjectId, amount: f64) -> Result<()> {
    // 1. 扣减源账户余额
    let deduct_result = deduct_balance(from_account, amount).await?;
    
    // 2. 增加目标账户余额
    match add_balance(to_account, amount).await {
        Ok(_) => Ok(()),
        Err(e) => {
            // 补偿: 回退源账户扣减
            compensate_deduct(from_account, amount).await?;
            Err(e)
        }
    }
}
```

### 6.2 缓存一致性

使用**延迟双删**策略:

```rust
async fn update_account_balance(account_id: ObjectId, new_balance: f64) -> Result<()> {
    // 1. 删除缓存
    cache.delete(&format!("abook:account:{}:balance", account_id)).await?;
    
    // 2. 更新数据库
    db.update_balance(account_id, new_balance).await?;
    
    // 3. 延迟后再次删除缓存 (避免脏读)
    tokio::time::sleep(Duration::from_millis(500)).await;
    cache.delete(&format!("abook:account:{}:balance", account_id)).await?;
    
    Ok(())
}
```

## 7. 数据备份与恢复

### 7.1 备份策略

| 数据库 | 备份频率 | 备份方式 | 保留时长 |
|-------|---------|---------|---------|
| MongoDB | 每日全量 + 实时增量 | mongodump + oplog | 30天 |
| PostgreSQL | 每日全量 + WAL归档 | pg_dump + pg_basebackup | 30天 |
| Redis | 每小时RDB + AOF | BGSAVE + AOF | 7天 |
| TimescaleDB | 每周全量 | pg_dump | 90天 |

### 7.2 恢复流程

```bash
# MongoDB 恢复
mongorestore --host=localhost --port=27017 --db=abook /backup/abook_20241202

# PostgreSQL 恢复
psql -U postgres -d abook < /backup/abook_20241202.sql

# Redis 恢复
redis-cli --rdb /backup/dump.rdb

# TimescaleDB 恢复
psql -U postgres -d abook_timeseries < /backup/timeseries_20241202.sql
```

## 8. 性能优化

### 8.1 查询优化

#### 分页优化
```javascript
// 游标分页 (推荐)
db.transactions.find({ 
  user_id: userId, 
  _id: { $lt: lastId } 
})
.sort({ _id: -1 })
.limit(20);

// 避免深分页 (性能差)
db.transactions.find({ user_id: userId })
.skip(10000)  // ❌ 慢
.limit(20);
```

#### 覆盖索引查询
```javascript
// 创建覆盖索引
db.transactions.createIndex({ 
  user_id: 1, 
  transaction_date: -1, 
  amount: 1, 
  category_id: 1 
});

// 查询只返回索引字段
db.transactions.find(
  { user_id: userId },
  { transaction_date: 1, amount: 1, category_id: 1, _id: 0 }
);
```

### 8.2 聚合优化

```javascript
// 优化后的月度统计聚合
db.transactions.aggregate([
  // 1. 匹配阶段 - 利用索引
  { 
    $match: { 
      user_id: userId, 
      transaction_date: { 
        $gte: startDate, 
        $lte: endDate 
      } 
    } 
  },
  // 2. 投影阶段 - 减少数据传输
  {
    $project: {
      category_id: 1,
      amount: 1,
      type: 1
    }
  },
  // 3. 分组统计
  {
    $group: {
      _id: "$category_id",
      total: { $sum: "$amount" },
      count: { $sum: 1 }
    }
  },
  // 4. 排序
  { $sort: { total: -1 } },
  // 5. 限制结果
  { $limit: 10 }
]);
```

### 8.3 连接池配置

```rust
// MongoDB 连接池
let client_options = ClientOptions::builder()
    .hosts(vec![ServerAddress::from("localhost:27017")])
    .min_pool_size(10)
    .max_pool_size(50)
    .max_idle_time(Duration::from_secs(600))
    .build();

// Redis 连接池
let pool = deadpool_redis::Config {
    max_size: 20,
    timeouts: Timeouts {
        wait: Some(Duration::from_secs(5)),
        create: Some(Duration::from_secs(5)),
        recycle: Some(Duration::from_secs(5)),
    },
    ..Default::default()
}.create_pool(Some(Runtime::Tokio1))?;
```

## 9. 数据迁移

### 9.1 版本迁移脚本

```javascript
// migrations/v1_to_v2.js
// 添加新字段示例
db.transactions.updateMany(
  { dedup_hash: { $exists: false } },
  { 
    $set: { 
      dedup_hash: null,
      external_id: null 
    } 
  }
);

// 创建新索引
db.transactions.createIndex({ 
  user_id: 1, 
  dedup_hash: 1 
}, { 
  unique: true, 
  sparse: true 
});
```

### 9.2 数据清理

```javascript
// 定期清理软删除数据 (30天前)
db.transactions.deleteMany({
  status: "deleted",
  updated_at: { $lt: new Date(Date.now() - 30 * 86400000) }
});

// 归档历史数据 (1年前)
db.transactions.aggregate([
  { 
    $match: { 
      transaction_date: { $lt: new Date(Date.now() - 365 * 86400000) } 
    } 
  },
  { $out: "transactions_archive" }
]);
```

