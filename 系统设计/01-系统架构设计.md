# 系统架构设计

## 1. 整体架构概览

### 1.1 架构风格
采用**微服务架构**，前后端分离，支持水平扩展和独立部署。

```
┌─────────────────────────────────────────────────────────────┐
│                         客户端层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web 端     │  │  移动端 App  │  │   小程序     │      │
│  │ React + Vite │  │ React Native │  │   Taro       │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼──────────────────┼──────────────────┼──────────────┘
          │                  │                  │
          └──────────────────┴──────────────────┘
                             │
          ┌──────────────────▼──────────────────┐
          │         API 网关 (Nginx)            │
          │  - 负载均衡                         │
          │  - 路由分发                         │
          │  - SSL 终止                         │
          │  - 限流熔断                         │
          └──────────────────┬──────────────────┘
                             │
          ┌──────────────────▼──────────────────┐
          │         后端服务层 (Rust)           │
          ├─────────────────────────────────────┤
          │  ┌─────────────────────────────┐    │
          │  │   用户服务 (User Service)   │    │
          │  │  - 认证授权 (JWT)           │    │
          │  │  - 用户管理                 │    │
          │  │  - 权限控制                 │    │
          │  └─────────────────────────────┘    │
          │                                      │
          │  ┌─────────────────────────────┐    │
          │  │  账户服务 (Account Service) │    │
          │  │  - 账户CRUD                 │    │
          │  │  - 余额计算                 │    │
          │  │  - 多币种支持               │    │
          │  └─────────────────────────────┘    │
          │                                      │
          │  ┌─────────────────────────────┐    │
          │  │ 交易服务 (Transaction Svc)  │    │
          │  │  - 交易记录                 │    │
          │  │  - 批量导入                 │    │
          │  │  - 智能去重                 │    │
          │  └─────────────────────────────┘    │
          │                                      │
          │  ┌─────────────────────────────┐    │
          │  │  预算服务 (Budget Service)  │    │
          │  │  - 预算管理                 │    │
          │  │  - 实时预警                 │    │
          │  │  - 预测算法                 │    │
          │  └─────────────────────────────┘    │
          │                                      │
          │  ┌─────────────────────────────┐    │
          │  │  报表服务 (Report Service)  │    │
          │  │  - 统计分析                 │    │
          │  │  - 图表生成                 │    │
          │  │  - 导出功能                 │    │
          │  └─────────────────────────────┘    │
          │                                      │
          │  ┌─────────────────────────────┐    │
          │  │  行情服务 (Quote Service)   │    │
          │  │  - 汇率获取                 │    │
          │  │  - 资产估值                 │    │
          │  │  - 卡尔曼融合               │    │
          │  └─────────────────────────────┘    │
          └──────────────────┬──────────────────┘
                             │
          ┌──────────────────▼──────────────────┐
          │         数据存储层                  │
          ├─────────────────────────────────────┤
          │  ┌────────────┐  ┌────────────┐    │
          │  │  MongoDB   │  │   Redis    │    │
          │  │  (主存储)  │  │  (缓存)    │    │
          │  └────────────┘  └────────────┘    │
          │                                      │
          │  ┌────────────┐  ┌────────────┐    │
          │  │PostgreSQL  │  │ TimescaleDB│    │
          │  │ (用户数据) │  │ (时序数据) │    │
          │  └────────────┘  └────────────┘    │
          └─────────────────────────────────────┘
                             │
          ┌──────────────────▼──────────────────┐
          │         消息队列 (RabbitMQ)         │
          │  - 异步任务处理                     │
          │  - 事件驱动通信                     │
          └─────────────────────────────────────┘
```

## 2. 技术栈选型

### 2.1 后端技术栈

| 技术组件 | 选型 | 理由 |
|---------|------|------|
| **编程语言** | Rust 1.75+ | 内存安全、零成本抽象、高性能并发 |
| **Web框架** | Axum 0.7 | 异步性能优异、类型安全、中间件丰富 |
| **异步运行时** | Tokio 1.35 | 工业级异步运行时，生态完善 |
| **序列化** | Serde + serde_json | 高性能、类型安全的序列化框架 |
| **数据库驱动** | MongoDB Driver 2.8 | 官方驱动，支持异步操作 |
| **Redis客户端** | redis-rs + deadpool-redis | 连接池管理，异步支持 |
| **认证授权** | jsonwebtoken 9.2 | JWT标准实现 |
| **日志** | tracing + tracing-subscriber | 结构化日志，异步友好 |
| **配置管理** | config 0.14 | 多环境配置支持 |
| **测试框架** | cargo test + rstest | 单元测试与集成测试 |

### 2.2 前端技术栈

| 技术组件 | 选型 | 理由 |
|---------|------|------|
| **框架** | React 18 | 生态成熟、组件化开发 |
| **构建工具** | Vite 5 | 极速热更新、现代化构建 |
| **语言** | TypeScript 5 | 类型安全、开发效率高 |
| **状态管理** | Zustand | 轻量级、简单易用 |
| **路由** | React Router 6 | 标准路由方案 |
| **UI组件库** | Ant Design 5 | 企业级UI、组件丰富 |
| **图表** | ECharts 5 + Apache ECharts for React | 强大的可视化能力 |
| **HTTP客户端** | Axios 1.6 | 拦截器、请求取消支持 |
| **表单** | React Hook Form | 高性能表单管理 |
| **CSS方案** | Tailwind CSS | 原子化CSS、快速开发 |

### 2.3 基础设施

| 组件 | 选型 | 理由 |
|-----|------|------|
| **API网关** | Nginx 1.24 | 高性能反向代理 |
| **数据库** | MongoDB 7.0 | 灵活schema、事务支持 |
| **缓存** | Redis 7.2 | 高性能内存存储 |
| **消息队列** | RabbitMQ 3.12 | 可靠消息传递 |
| **时序数据库** | TimescaleDB 2.13 | PostgreSQL扩展、时序优化 |
| **容器化** | Docker + Docker Compose | 标准化部署 |
| **容器编排** | Kubernetes (可选) | 生产环境扩展 |
| **监控** | Prometheus + Grafana | 指标采集与可视化 |
| **日志收集** | Loki + Promtail | 轻量级日志聚合 |
| **链路追踪** | Jaeger | 分布式追踪 |

## 3. 微服务划分

### 3.1 服务职责

#### 3.1.1 用户服务 (user-service)
- **端口**: 8001
- **职责**:
  - 用户注册、登录、登出
  - JWT令牌生成与验证
  - 密码加密与验证
  - 用户信息CRUD
  - 权限管理
- **数据库**: PostgreSQL (users表)
- **缓存**: Redis (session、token黑名单)

#### 3.1.2 账户服务 (account-service)
- **端口**: 8002
- **职责**:
  - 账户创建、修改、删除、查询
  - 账户类型管理(现金、银行卡、信用卡、投资账户等)
  - 账户余额实时计算
  - 多币种账户支持
  - 账户快照生成
- **数据库**: MongoDB (accounts集合)
- **缓存**: Redis (账户余额、快照)

#### 3.1.3 交易服务 (transaction-service)
- **端口**: 8003
- **职责**:
  - 交易记录创建、修改、删除、查询
  - 批量导入(CSV、Excel、API对接)
  - 智能去重算法
  - 交易分类管理
  - 交易标签系统
  - 附件管理(票据照片等)
- **数据库**: MongoDB (transactions、categories集合)
- **缓存**: Redis (热点交易)
- **消息队列**: 发送交易事件到预算服务

#### 3.1.4 预算服务 (budget-service)
- **端口**: 8004
- **职责**:
  - 预算设定与管理
  - 实时预算执行监控
  - 滑动窗口预测算法
  - 预算预警推送
  - 预算报告生成
- **数据库**: MongoDB (budgets集合)
- **时序数据**: TimescaleDB (预算执行历史)
- **消息队列**: 订阅交易事件

#### 3.1.5 报表服务 (report-service)
- **端口**: 8005
- **职责**:
  - 多维度统计分析
  - 收支趋势分析
  - 分类占比分析
  - 资产负债表生成
  - 现金流量表生成
  - 报表导出(PDF、Excel、CSV)
  - 自定义仪表盘
- **数据库**: MongoDB (读取所有集合)
- **缓存**: Redis (报表结果缓存)

#### 3.1.6 行情服务 (quote-service)
- **端口**: 8006
- **职责**:
  - 实时汇率获取
  - 股票、基金行情获取
  - 多数据源融合(卡尔曼滤波)
  - 资产净值计算
  - 历史行情数据存储
- **外部API**: Yahoo Finance、央行汇率API
- **数据库**: TimescaleDB (历史行情)
- **缓存**: Redis (实时行情)

### 3.2 服务通信

#### 3.2.1 同步通信 (HTTP/REST)
- 客户端→API网关→各微服务
- 服务间查询操作(如报表服务查询账户信息)

#### 3.2.2 异步通信 (消息队列)
- 交易创建 → 预算服务(更新预算执行)
- 交易创建 → 报表服务(更新缓存)
- 行情更新 → 账户服务(更新资产净值)

#### 3.2.3 事件类型
```rust
pub enum Event {
    TransactionCreated(TransactionCreatedEvent),
    TransactionUpdated(TransactionUpdatedEvent),
    TransactionDeleted(TransactionDeletedEvent),
    QuoteUpdated(QuoteUpdatedEvent),
    BudgetExceeded(BudgetExceededEvent),
}
```

## 4. 部署架构

### 4.1 开发环境
```yaml
# docker-compose.dev.yml
version: '3.8'
services:
  nginx:
    image: nginx:1.24
    ports: [80:80]
  
  user-service:
    build: ./services/user-service
    ports: [8001:8001]
    environment:
      - RUST_LOG=debug
  
  account-service:
    build: ./services/account-service
    ports: [8002:8002]
  
  # ... 其他服务
  
  mongodb:
    image: mongo:7.0
    ports: [27017:27017]
  
  redis:
    image: redis:7.2
    ports: [6379:6379]
  
  postgres:
    image: postgres:16
    ports: [5432:5432]
  
  timescaledb:
    image: timescale/timescaledb:2.13-pg16
    ports: [5433:5432]
  
  rabbitmq:
    image: rabbitmq:3.12-management
    ports: [5672:5672, 15672:15672]
```

### 4.2 生产环境 (Kubernetes)

#### 4.2.1 命名空间
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: abook-prod
```

#### 4.2.2 服务部署
```yaml
# 示例：account-service deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: account-service
  namespace: abook-prod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: account-service
  template:
    metadata:
      labels:
        app: account-service
    spec:
      containers:
      - name: account-service
        image: abook/account-service:1.0.0
        ports:
        - containerPort: 8002
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-credentials
              key: mongodb-url
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8002
          initialDelaySeconds: 5
          periodSeconds: 5
```

#### 4.2.3 水平自动扩展
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: account-service-hpa
  namespace: abook-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: account-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

## 5. 性能优化策略

### 5.1 并发处理
- **Tokio异步运行时**: 多线程任务调度，充分利用CPU核心
- **连接池管理**: MongoDB连接池(10-50)、Redis连接池(5-20)
- **请求批处理**: 批量查询优化，减少网络往返

### 5.2 缓存策略
- **多级缓存**:
  - L1: 内存缓存(LRU, 容量10MB)
  - L2: Redis缓存(容量1GB)
  - L3: MongoDB(持久化存储)

- **缓存更新策略**:
  - 写穿(Write-Through): 同步更新缓存
  - 旁路缓存(Cache-Aside): 读时加载
  - TTL设置: 热点数据5分钟，冷数据1小时

### 5.3 数据库优化
- **索引设计**: 复合索引、覆盖索引
- **分页优化**: 游标分页，避免深分页
- **查询优化**: Projection减少字段、聚合管道优化
- **读写分离**: MongoDB副本集读偏好设置

### 5.4 负载均衡
- **Nginx负载均衡算法**: 加权轮询
- **健康检查**: 被动健康检查 + 主动探测
- **限流**: 令牌桶算法，单IP限流100req/s

## 6. 监控与告警

### 6.1 监控指标
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: QPS、延迟(P50/P95/P99)、错误率
- **业务指标**: 在线用户数、交易量、预算超支次数

### 6.2 告警规则
```yaml
groups:
- name: abook-alerts
  rules:
  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
    for: 5m
    annotations:
      summary: "服务 {{ $labels.service }} 错误率超过5%"
  
  - alert: HighLatency
    expr: histogram_quantile(0.95, http_request_duration_seconds_bucket) > 0.1
    for: 5m
    annotations:
      summary: "服务 {{ $labels.service }} P95延迟超过100ms"
```

## 7. 安全架构

### 7.1 网络安全
- **HTTPS**: 全站加密，TLS 1.3
- **WAF**: 防护SQL注入、XSS攻击
- **DDoS防护**: CDN + 限流

### 7.2 应用安全
- **认证**: JWT + 刷新令牌机制
- **授权**: RBAC权限模型
- **数据加密**: 敏感数据AES-256加密
- **密码安全**: Argon2id哈希算法

### 7.3 数据安全
- **数据备份**: 每日增量备份 + 每周全量备份
- **备份加密**: GPG加密备份文件
- **灾难恢复**: RTO < 1小时, RPO < 15分钟

## 8. 扩展性设计

### 8.1 水平扩展
- 无状态服务设计
- 负载均衡自动分配
- 数据库分片(Sharding)准备

### 8.2 垂直扩展
- 资源限制动态调整
- 数据库连接池动态扩容
- 缓存容量按需扩展

### 8.3 未来演进
- **插件化架构**: 支持第三方插件市场
- **多租户**: SaaS化改造
- **边缘计算**: 离线记账 + 同步
- **AI增强**: 智能分类、异常检测
