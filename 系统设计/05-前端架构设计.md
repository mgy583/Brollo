# 前端架构设计

## 1. 整体架构

### 1.1 技术栈

```
React 18 + TypeScript 5 + Vite 5
├── 状态管理: Zustand
├── 路由: React Router 6
├── UI库: Ant Design 5
├── 图表: ECharts 5
├── HTTP: Axios
├── 表单: React Hook Form
├── CSS: Tailwind CSS
└── 构建: Vite
```

### 1.2 项目结构

```
frontend/
├── public/
│   ├── favicon.ico
│   └── logo.png
├── src/
│   ├── api/              # API接口封装
│   │   ├── client.ts     # Axios实例配置
│   │   ├── auth.ts       # 认证相关API
│   │   ├── accounts.ts   # 账户API
│   │   ├── transactions.ts
│   │   ├── budgets.ts
│   │   └── reports.ts
│   ├── assets/           # 静态资源
│   │   ├── images/
│   │   └── icons/
│   ├── components/       # 通用组件
│   │   ├── common/       # 基础组件
│   │   │   ├── Button/
│   │   │   ├── Modal/
│   │   │   └── Table/
│   │   ├── layout/       # 布局组件
│   │   │   ├── Header/
│   │   │   ├── Sidebar/
│   │   │   └── Footer/
│   │   └── charts/       # 图表组件
│   │       ├── LineChart/
│   │       ├── PieChart/
│   │       └── BarChart/
│   ├── features/         # 功能模块
│   │   ├── auth/         # 认证模块
│   │   │   ├── components/
│   │   │   ├── hooks/
│   │   │   └── store/
│   │   ├── accounts/     # 账户模块
│   │   ├── transactions/ # 交易模块
│   │   ├── budgets/      # 预算模块
│   │   ├── reports/      # 报表模块
│   │   └── dashboard/    # 仪表盘模块
│   ├── hooks/            # 自定义Hooks
│   │   ├── useAuth.ts
│   │   ├── useDebounce.ts
│   │   └── useWebSocket.ts
│   ├── store/            # 全局状态
│   │   ├── authStore.ts
│   │   ├── accountStore.ts
│   │   └── uiStore.ts
│   ├── types/            # TypeScript类型定义
│   │   ├── api.ts
│   │   ├── models.ts
│   │   └── common.ts
│   ├── utils/            # 工具函数
│   │   ├── format.ts
│   │   ├── validation.ts
│   │   └── storage.ts
│   ├── router/           # 路由配置
│   │   └── index.tsx
│   ├── App.tsx
│   ├── main.tsx
│   └── vite-env.d.ts
├── .env.development
├── .env.production
├── index.html
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

## 2. 核心配置

### 2.1 Vite配置

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@components': path.resolve(__dirname, './src/components'),
      '@features': path.resolve(__dirname, './src/features'),
      '@api': path.resolve(__dirname, './src/api'),
      '@utils': path.resolve(__dirname, './src/utils'),
      '@hooks': path.resolve(__dirname, './src/hooks'),
      '@store': path.resolve(__dirname, './src/store'),
      '@types': path.resolve(__dirname, './src/types'),
    },
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      },
    },
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'ui-vendor': ['antd', '@ant-design/icons'],
          'chart-vendor': ['echarts', 'echarts-for-react'],
        },
      },
    },
  },
});
```

### 2.2 TypeScript配置

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@components/*": ["./src/components/*"],
      "@features/*": ["./src/features/*"],
      "@api/*": ["./src/api/*"],
      "@utils/*": ["./src/utils/*"],
      "@hooks/*": ["./src/hooks/*"],
      "@store/*": ["./src/store/*"],
      "@types/*": ["./src/types/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

### 2.3 Tailwind CSS配置

```javascript
// tailwind.config.js
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: '#1890ff',
        success: '#52c41a',
        warning: '#faad14',
        error: '#f5222d',
      },
    },
  },
  plugins: [],
  corePlugins: {
    preflight: false, // 避免与Ant Design冲突
  },
}
```

## 3. API层设计

### 3.1 Axios封装

```typescript
// src/api/client.ts
import axios, { AxiosError, AxiosRequestConfig, AxiosResponse } from 'axios';
import { message } from 'antd';
import { useAuthStore } from '@store/authStore';

const client = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api/v1',
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 请求拦截器
client.interceptors.request.use(
  (config) => {
    const token = useAuthStore.getState().token;
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    
    // 添加请求ID
    config.headers['X-Request-ID'] = crypto.randomUUID();
    config.headers['X-Client-Version'] = '1.0.0';
    
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// 响应拦截器
client.interceptors.response.use(
  (response: AxiosResponse) => {
    return response.data;
  },
  async (error: AxiosError<ApiErrorResponse>) => {
    const { response } = error;
    
    if (response) {
      switch (response.status) {
        case 401:
          // 未授权，尝试刷新令牌
          const refreshed = await refreshToken();
          if (refreshed && error.config) {
            return client.request(error.config);
          }
          // 刷新失败，跳转登录
          useAuthStore.getState().logout();
          window.location.href = '/login';
          break;
        
        case 403:
          message.error('无权限访问');
          break;
        
        case 404:
          message.error('请求的资源不存在');
          break;
        
        case 429:
          message.warning('请求过于频繁，请稍后再试');
          break;
        
        case 500:
          message.error('服务器错误，请稍后再试');
          break;
        
        default:
          const errorMsg = response.data?.error?.message || '请求失败';
          message.error(errorMsg);
      }
    } else {
      message.error('网络错误，请检查网络连接');
    }
    
    return Promise.reject(error);
  }
);

// 刷新令牌
async function refreshToken(): Promise<boolean> {
  try {
    const refreshToken = useAuthStore.getState().refreshToken;
    if (!refreshToken) return false;
    
    const response = await axios.post('/api/v1/auth/refresh', {
      refresh_token: refreshToken,
    });
    
    useAuthStore.getState().setToken(response.data.data.access_token);
    return true;
  } catch {
    return false;
  }
}

export default client;

// 类型定义
interface ApiErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: any;
  };
  timestamp: string;
  request_id: string;
}
```

### 3.2 API接口定义

```typescript
// src/api/accounts.ts
import client from './client';
import { Account, AccountCreatePayload, ApiResponse } from '@types/api';

export const accountsApi = {
  // 获取账户列表
  getAccounts: (params?: {
    status?: 'active' | 'archived';
    type?: string;
  }): Promise<ApiResponse<{ accounts: Account[] }>> => {
    return client.get('/accounts', { params });
  },
  
  // 获取账户详情
  getAccount: (id: string): Promise<ApiResponse<Account>> => {
    return client.get(`/accounts/${id}`);
  },
  
  // 创建账户
  createAccount: (data: AccountCreatePayload): Promise<ApiResponse<Account>> => {
    return client.post('/accounts', data);
  },
  
  // 更新账户
  updateAccount: (id: string, data: Partial<AccountCreatePayload>): Promise<ApiResponse<Account>> => {
    return client.patch(`/accounts/${id}`, data);
  },
  
  // 删除账户
  deleteAccount: (id: string): Promise<ApiResponse<void>> => {
    return client.delete(`/accounts/${id}`);
  },
  
  // 获取余额历史
  getBalanceHistory: (id: string, params: {
    start_date: string;
    end_date: string;
    interval: 'day' | 'week' | 'month';
  }): Promise<ApiResponse<{ history: any[] }>> => {
    return client.get(`/accounts/${id}/balance-history`, { params });
  },
};
```

## 4. 状态管理

### 4.1 认证状态

```typescript
// src/store/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: string;
  username: string;
  email: string;
  full_name: string;
  avatar_url?: string;
}

interface AuthState {
  token: string | null;
  refreshToken: string | null;
  user: User | null;
  isAuthenticated: boolean;
  
  setToken: (token: string) => void;
  setRefreshToken: (token: string) => void;
  setUser: (user: User) => void;
  login: (token: string, refreshToken: string, user: User) => void;
  logout: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      token: null,
      refreshToken: null,
      user: null,
      isAuthenticated: false,
      
      setToken: (token) => set({ token, isAuthenticated: true }),
      setRefreshToken: (refreshToken) => set({ refreshToken }),
      setUser: (user) => set({ user }),
      
      login: (token, refreshToken, user) => set({
        token,
        refreshToken,
        user,
        isAuthenticated: true,
      }),
      
      logout: () => set({
        token: null,
        refreshToken: null,
        user: null,
        isAuthenticated: false,
      }),
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        token: state.token,
        refreshToken: state.refreshToken,
        user: state.user,
      }),
    }
  )
);
```

### 4.2 账户状态

```typescript
// src/store/accountStore.ts
import { create } from 'zustand';
import { Account } from '@types/models';

interface AccountState {
  accounts: Account[];
  selectedAccountId: string | null;
  loading: boolean;
  
  setAccounts: (accounts: Account[]) => void;
  addAccount: (account: Account) => void;
  updateAccount: (id: string, data: Partial<Account>) => void;
  deleteAccount: (id: string) => void;
  selectAccount: (id: string | null) => void;
  setLoading: (loading: boolean) => void;
}

export const useAccountStore = create<AccountState>((set) => ({
  accounts: [],
  selectedAccountId: null,
  loading: false,
  
  setAccounts: (accounts) => set({ accounts }),
  
  addAccount: (account) => set((state) => ({
    accounts: [...state.accounts, account],
  })),
  
  updateAccount: (id, data) => set((state) => ({
    accounts: state.accounts.map((acc) =>
      acc.id === id ? { ...acc, ...data } : acc
    ),
  })),
  
  deleteAccount: (id) => set((state) => ({
    accounts: state.accounts.filter((acc) => acc.id !== id),
  })),
  
  selectAccount: (id) => set({ selectedAccountId: id }),
  
  setLoading: (loading) => set({ loading }),
}));
```

## 5. 路由设计

```typescript
// src/router/index.tsx
import { createBrowserRouter, Navigate } from 'react-router-dom';
import { lazy, Suspense } from 'react';
import MainLayout from '@components/layout/MainLayout';
import AuthLayout from '@components/layout/AuthLayout';
import ProtectedRoute from '@components/common/ProtectedRoute';
import LoadingSpinner from '@components/common/LoadingSpinner';

// 懒加载页面组件
const Dashboard = lazy(() => import('@features/dashboard/Dashboard'));
const Accounts = lazy(() => import('@features/accounts/AccountsList'));
const AccountDetail = lazy(() => import('@features/accounts/AccountDetail'));
const Transactions = lazy(() => import('@features/transactions/TransactionsList'));
const Budgets = lazy(() => import('@features/budgets/BudgetsList'));
const Reports = lazy(() => import('@features/reports/ReportsPage'));
const Settings = lazy(() => import('@features/settings/SettingsPage'));
const Login = lazy(() => import('@features/auth/Login'));
const Register = lazy(() => import('@features/auth/Register'));

const router = createBrowserRouter([
  {
    path: '/',
    element: <ProtectedRoute><MainLayout /></ProtectedRoute>,
    children: [
      {
        index: true,
        element: <Navigate to="/dashboard" replace />,
      },
      {
        path: 'dashboard',
        element: (
          <Suspense fallback={<LoadingSpinner />}>
            <Dashboard />
          </Suspense>
        ),
      },
      {
        path: 'accounts',
        children: [
          {
            index: true,
            element: (
              <Suspense fallback={<LoadingSpinner />}>
                <Accounts />
              </Suspense>
            ),
          },
          {
            path: ':id',
            element: (
              <Suspense fallback={<LoadingSpinner />}>
                <AccountDetail />
              </Suspense>
            ),
          },
        ],
      },
      {
        path: 'transactions',
        element: (
          <Suspense fallback={<LoadingSpinner />}>
            <Transactions />
          </Suspense>
        ),
      },
      {
        path: 'budgets',
        element: (
          <Suspense fallback={<LoadingSpinner />}>
            <Budgets />
          </Suspense>
        ),
      },
      {
        path: 'reports',
        element: (
          <Suspense fallback={<LoadingSpinner />}>
            <Reports />
          </Suspense>
        ),
      },
      {
        path: 'settings',
        element: (
          <Suspense fallback={<LoadingSpinner />}>
            <Settings />
          </Suspense>
        ),
      },
    ],
  },
  {
    path: '/auth',
    element: <AuthLayout />,
    children: [
      {
        path: 'login',
        element: (
          <Suspense fallback={<LoadingSpinner />}>
            <Login />
          </Suspense>
        ),
      },
      {
        path: 'register',
        element: (
          <Suspense fallback={<LoadingSpinner />}>
            <Register />
          </Suspense>
        ),
      },
    ],
  },
  {
    path: '*',
    element: <Navigate to="/dashboard" replace />,
  },
]);

export default router;
```

## 6. 核心组件

### 6.1 主布局

```typescript
// src/components/layout/MainLayout.tsx
import { Layout, Menu } from 'antd';
import { Outlet, useNavigate, useLocation } from 'react-router-dom';
import {
  DashboardOutlined,
  WalletOutlined,
  TransactionOutlined,
  PieChartOutlined,
  BarChartOutlined,
  SettingOutlined,
} from '@ant-design/icons';

const { Header, Sider, Content } = Layout;

const MainLayout = () => {
  const navigate = useNavigate();
  const location = useLocation();
  
  const menuItems = [
    {
      key: '/dashboard',
      icon: <DashboardOutlined />,
      label: '仪表盘',
    },
    {
      key: '/accounts',
      icon: <WalletOutlined />,
      label: '账户管理',
    },
    {
      key: '/transactions',
      icon: <TransactionOutlined />,
      label: '交易记录',
    },
    {
      key: '/budgets',
      icon: <PieChartOutlined />,
      label: '预算管理',
    },
    {
      key: '/reports',
      icon: <BarChartOutlined />,
      label: '统计报表',
    },
    {
      key: '/settings',
      icon: <SettingOutlined />,
      label: '系统设置',
    },
  ];
  
  return (
    <Layout className="min-h-screen">
      <Sider theme="dark" width={200}>
        <div className="p-4 text-white text-xl font-bold">
          ABook 记账
        </div>
        <Menu
          theme="dark"
          mode="inline"
          selectedKeys={[location.pathname]}
          items={menuItems}
          onClick={({ key }) => navigate(key)}
        />
      </Sider>
      <Layout>
        <Header className="bg-white px-6 shadow">
          <div className="flex justify-between items-center">
            <h1 className="text-lg font-semibold">记账系统</h1>
            <UserMenu />
          </div>
        </Header>
        <Content className="m-4 p-6 bg-white rounded-lg">
          <Outlet />
        </Content>
      </Layout>
    </Layout>
  );
};

export default MainLayout;
```

### 6.2 图表组件

```typescript
// src/components/charts/LineChart.tsx
import { useEffect, useRef } from 'react';
import * as echarts from 'echarts';

interface LineChartProps {
  data: {
    dates: string[];
    series: { name: string; data: number[] }[];
  };
  height?: string;
}

const LineChart: React.FC<LineChartProps> = ({ data, height = '400px' }) => {
  const chartRef = useRef<HTMLDivElement>(null);
  
  useEffect(() => {
    if (!chartRef.current) return;
    
    const chart = echarts.init(chartRef.current);
    
    const option = {
      tooltip: {
        trigger: 'axis',
      },
      legend: {
        data: data.series.map((s) => s.name),
      },
      xAxis: {
        type: 'category',
        data: data.dates,
      },
      yAxis: {
        type: 'value',
      },
      series: data.series.map((s) => ({
        name: s.name,
        type: 'line',
        data: s.data,
        smooth: true,
      })),
    };
    
    chart.setOption(option);
    
    // 响应式
    const handleResize = () => chart.resize();
    window.addEventListener('resize', handleResize);
    
    return () => {
      window.removeEventListener('resize', handleResize);
      chart.dispose();
    };
  }, [data]);
  
  return <div ref={chartRef} style={{ height }} />;
};

export default LineChart;
```

## 7. 自定义Hooks

### 7.1 useDebounce

```typescript
// src/hooks/useDebounce.ts
import { useEffect, useState } from 'react';

export function useDebounce<T>(value: T, delay: number = 500): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);
  
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);
    
    return () => {
      clearTimeout(timer);
    };
  }, [value, delay]);
  
  return debouncedValue;
}
```

### 7.2 useWebSocket

```typescript
// src/hooks/useWebSocket.ts
import { useEffect, useRef, useState } from 'react';
import { useAuthStore } from '@store/authStore';

interface UseWebSocketOptions {
  onMessage?: (data: any) => void;
  onOpen?: () => void;
  onClose?: () => void;
  onError?: (error: Event) => void;
}

export function useWebSocket(url: string, options: UseWebSocketOptions = {}) {
  const [isConnected, setIsConnected] = useState(false);
  const ws = useRef<WebSocket | null>(null);
  const token = useAuthStore((state) => state.token);
  
  useEffect(() => {
    if (!token) return;
    
    const wsUrl = `${url}?token=${token}`;
    ws.current = new WebSocket(wsUrl);
    
    ws.current.onopen = () => {
      setIsConnected(true);
      options.onOpen?.();
    };
    
    ws.current.onmessage = (event) => {
      const data = JSON.parse(event.data);
      options.onMessage?.(data);
    };
    
    ws.current.onclose = () => {
      setIsConnected(false);
      options.onClose?.();
    };
    
    ws.current.onerror = (error) => {
      options.onError?.(error);
    };
    
    return () => {
      ws.current?.close();
    };
  }, [url, token]);
  
  const send = (data: any) => {
    if (ws.current?.readyState === WebSocket.OPEN) {
      ws.current.send(JSON.stringify(data));
    }
  };
  
  return { isConnected, send };
}
```

## 8. 性能优化

### 8.1 代码分割

- 路由懒加载
- 组件懒加载
- 第三方库按需导入

### 8.2 列表虚拟化

```typescript
import { FixedSizeList } from 'react-window';

const VirtualList = ({ items, height = 600 }) => {
  const Row = ({ index, style }) => (
    <div style={style}>
      {items[index].name}
    </div>
  );
  
  return (
    <FixedSizeList
      height={height}
      itemCount={items.length}
      itemSize={50}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
};
```

### 8.3 缓存策略

- React Query缓存服务端数据
- LocalStorage缓存用户设置
- IndexedDB缓存离线数据

## 9. 构建优化

### 9.1 打包配置

```typescript
// vite.config.ts (build部分)
build: {
  target: 'es2015',
  minify: 'terser',
  terserOptions: {
    compress: {
      drop_console: true,
      drop_debugger: true,
    },
  },
  chunkSizeWarningLimit: 1000,
}
```

### 9.2 CDN加速

```html
<!-- index.html -->
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="dns-prefetch" href="https://api.example.com">
```

## 10. 测试策略

### 10.1 单元测试

```typescript
// src/components/__tests__/Button.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import Button from '../common/Button';

describe('Button', () => {
  it('renders correctly', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });
  
  it('handles click events', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);
    fireEvent.click(screen.getByText('Click me'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

### 10.2 E2E测试

使用Playwright或Cypress进行端到端测试。
